---
title: "Data analyses for Global Typhoid Genomics Consortium Paper - Working Group 1 (Descriptive Stats - genotypes)"
author: "Kat Holt"
date: "31/10/2022"
output:
  html_document:
    toc: true
#    toc_float: true
    toc_depth: 2
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = getwd())

# Data wrangling
library(tidyverse)
library(dplyr)
library(reshape2)
library(readxl)

# Plotting (general)
library(ggplot2)
library(RColorBrewer)
library(patchwork)
library(ggExtra)
library(pals) # so we can use longer colour palette "alphabet" for south asia lab plot

# Plotting (maps)
library(sf)
library(rvest)
library(maps)
library(scatterpie)
library(ggnewscale) # to allow us to specify different scales for countries and pies
library(janitor)
```

# Section 1 - Overview of available data

## Load data
``` {r load_data}

tgc_all <- read_csv("../TGC_data_311022.csv")

# total genomes
nrow(tgc_all)

```

## Genome size analysis
``` {r genome_sizes}

# genomes excluded due to size
table(tgc_all$exclude_assembly)

tgc_all <- tgc_all %>% 
  mutate(IncHI1=grepl("IncHI1",`Inc Types`))

table(tgc_all$IncHI1, tgc_all$exclude_assembly)

genome_sizes <- tgc_all %>% 
  ggplot( aes(y=`GENOME LENGTH`, x=IncHI1)) + 
      geom_violin() +
      theme_bw() + 
      geom_hline(yintercept = 4.5E6, linetype="dashed", color="blue") + 
      geom_hline(yintercept = 5.5E6, linetype="dashed", color="blue") +
      labs(x="IncHI1 detected", y="Genome length (bp)", subtitle="a) All genomes, pre-filter") + 
      scale_x_discrete(labels=c(paste0("yes (n=",sum(tgc_all$IncHI1),")"), paste0("no (n=",sum(!tgc_all$IncHI1),")")))

genome_sizes

genome_sizes_included <- tgc_all %>% 
  filter(exclude_assembly != TRUE) %>%
  ggplot( aes(y=`GENOME LENGTH`, x=IncHI1)) + 
      geom_violin() +
      theme_bw() + 
      labs(x="IncHI1 detected", y="Genome length (bp)", subtitle="b) Included genomes") + 
      scale_x_discrete(labels=c(paste0("yes (n=",sum(tgc_all$IncHI1[!tgc_all$exclude_assembly]),")"), paste0("no (n=",sum(!tgc_all$IncHI1[!tgc_all$exclude_assembly]),")")))

genome_sizes_included

```

## Fig S1 - genome size
``` {r genomesize_inc_pdf, eval=T}
pdf(paste0("SuppFig1_genomeSize_by_inc.pdf"), width=6, height=4)
genome_sizes | genome_sizes_included
dev.off()

png(paste0("SuppFig1_genomeSize_by_inc.png"), width=6, height=4, units="in", res=400)
genome_sizes | genome_sizes_included
dev.off()
```

## exclude genomes on basis of size

``` {r}
tgc_all <- tgc_all %>% filter(exclude_assembly != TRUE)

```

# Overview of dataset for text
``` {r}
# total high quality genomes
nrow(tgc_all)

# number of countries
length(table(tgc_all$Country_Origin))

# assumed acute cases
table(tgc_all$assumedAcute)

# non-targeted
tgc_all %>% filter(startsWith(`Purpose of Sampling`, "Non")) %>% summarise(n=n())

# targeted
tgc_all %>% filter(startsWith(`Purpose of Sampling`, "Targeted")) %>% summarise(n=n())

# purpose not provided
tgc_all %>% filter(`Purpose of Sampling` == "Not Provided") %>% summarise(n=n())
```

## Table S3 - samples and sources

``` {r eval=T}
source_vs_health <- table(tgc_all$Source,tgc_all$`Host Health State`)

source_vs_health <- rbind(source_vs_health, Total=colSums(source_vs_health))

source_vs_health <- source_vs_health[c("Blood", "Stool", "Urine", "Gallbladder", "Environment", "Other", "Not Provided", "Total"),c("Symptomatic", "Asymptomatic Carrier", "Not Provided")]

write.csv(source_vs_health, file=paste0("SuppTable3_health_vs_source_excludeFails.csv"))
```

## Table X - summary of contributing papers  
``` {r}
paper_summary <- tgc_all %>%
  mutate(source=ifelse(is.na(PMID), `Isolating Lab`, PMID)) %>%
    group_by(source)%>% 
    summarize(Total =n(),
              `Representative surveillance 2010-2020` =sum(Year >= 2010 & assumedAcute & untargetedSurveillance), 
              `Travel Associated`=sum(`Travel Associated`=="Yes" & Year >= 2010 & assumedAcute & untargetedSurveillance)) %>%
  adorn_totals("row")

paper_summary
```

``` {r eval=T}
write.csv(paper_summary, file=paste0("TableX_sourcePublication_summary.csv"), row.names=F)
```

## Table 1 - summary of genomes by region  
``` {r}
region_summary <- tgc_all %>%
    group_by(Region)%>% 
    summarize(region_total =n(),
              post2010_rep =sum(Year >= 2010 & assumedAcute & untargetedSurveillance), 
              travel_post2010=sum(`Travel Associated`=="Yes" & Year >= 2010 & assumedAcute & untargetedSurveillance), 
              
              ) %>%
  adorn_totals("row") %>%
  mutate(travel_post2010_pc = paste0(travel_post2010, " (", 
                                          round(travel_post2010/post2010_rep*100,1), "%)")
  ) %>% 
  select(Region, region_total, post2010_rep, travel_post2010_pc) %>% 
  rename(`Total genomes`=region_total, `Representative cases from 2010`=post2010_rep, `Travel (%) amongst representative cases from 2010`=travel_post2010_pc) %>%
  mutate(Region=replace(Region, is.na(Region), "Unknown"))

region_summary

```

``` {r eval=T}
write.csv(region_summary, file=paste0("Table1_region_summary.csv"), row.names=F)
```

## Table S4 - country breakdown 
``` {r}
country_summary <- tgc_all %>%
    group_by(Region, Country_Origin)%>% 
    summarize(n =n(),
              travel = sum(`Travel Associated`=="Yes"),
              untargeted_from2010 =sum(Year >= 2010 & assumedAcute & untargetedSurveillance), 
              travel_untargeted_from2010 = sum(`Travel Associated`=="Yes" & Year >= 2010 & assumedAcute & untargetedSurveillance), 
              ) %>%
    adorn_totals("row") %>%
    mutate(travel_pc = paste0(travel, " (", round(travel/n*100,1), "%)")) %>%
    mutate(travel_untargeted_from2010_pc = paste0(travel_untargeted_from2010, " (", round(travel_untargeted_from2010/untargeted_from2010*100,1), "%)")) %>%
  select(Region, Country_Origin, n, travel_pc, untargeted_from2010, travel_untargeted_from2010_pc) %>% 
  rename(`Total genomes`=n, 
         `Travel (%)`=travel_pc,
         `Representative cases from 2010`=untargeted_from2010, 
         `Travel (%) amongst representative cases from 2010`=travel_untargeted_from2010_pc) %>%
  mutate(Region=replace(Region, is.na(Region), "Unknown"))

```

``` {r eval=T}
write.csv(country_summary, file=paste0("SuppTable4_country_summary.csv"), row.names=F)
```

## country level counts for text
``` {r}
country_count_by_region <- table(paste0(tgc_all$Region, ": ", tgc_all$Country_Origin))

sum(country_count_by_region>=20)

sum(country_count_by_region[country_count_by_region>=20])-225 # subtract the 'unknown' category

(sum(country_count_by_region[country_count_by_region>=20])-225)/nrow(tgc_all)
sum(country_count_by_region>=100)

sum(country_count_by_region[country_count_by_region>=100])-225 # subtract the 'unknown' category

(sum(country_count_by_region[country_count_by_region>=100])-225)/nrow(tgc_all)
```

## travel summary for text
``` {r}
table(tgc_all$`Travel Associated`)

# labs contirbuting travel-associated isolates
tgc_all %>% group_by(`Isolating Lab`, `Travel Associated`) %>% summarise (n=n()) %>% filter(`Travel Associated`=="Yes")

# country of origin for travel-associated isolates
tgc_all %>% group_by(Country_Origin, `Travel Associated`) %>% summarise (n=n()) %>% filter(`Travel Associated`=="Yes") %>% filter(n>35)

```

## define representative subsets for analysis - counts for text
``` {r}

# surveillance-ready samples only

tgc_meta <- tgc_all %>%
  filter(assumedAcute == T, 
         untargetedSurveillance == T,
         Country_Origin != "Not Provided")

nrow(tgc_meta)

# surveillance-ready samples, known years, 2010 onwards
tgc_from2010 <- tgc_all %>%
  filter(assumedAcute == T, 
         untargetedSurveillance == T,
         Country_Origin != "Not Provided",
         Year >=2010)

nrow(tgc_from2010)

nrow(tgc_from2010)/nrow(tgc_meta)
```


# Section 2 - Geographic distribution of genotypes

## Table S5: genotype prevalence per region, 2010-2020
``` {r}
region_N_from2010 <- tgc_from2010 %>%
  group_by(Region)%>% 
  summarize(N =n())

tgc_from2010_regionFreq_allGeno <- tgc_from2010 %>%
  group_by(Region, Final_genotype)%>% 
  summarize(x =n()) %>%
  left_join(region_N_from2010) %>% # region counts
  mutate(p = x/N) %>% # proportion per region
  mutate(se = sqrt(p*(1-p)/N)) %>%
  mutate(p_lowerCI = p-1.96*se, p_upperCI = p+1.96*se) %>%
  mutate(p_lowerCI = replace(p_lowerCI, p_lowerCI<0, 0)) %>%
  mutate(p_upperCI = replace(p_upperCI, p_upperCI>1, 1)) %>%
  select(-se)


# annual counts/freqs
region_N_annual <- tgc_from2010 %>%
  group_by(Region, Year)%>% 
  summarize(N =n())

tgc_from2010_regionFreq_allGeno_annual <- tgc_from2010 %>%
  group_by(Region, Final_genotype, Year)%>% 
  summarize(x =n()) %>%
  left_join(region_N_annual) %>% # regional annual
  mutate(p = x/N) %>% # proportion per region
  mutate(se = sqrt(p*(1-p)/N)) %>%
  mutate(p_lowerCI = p-1.96*se, p_upperCI = p+1.96*se) %>%
  mutate(p_lowerCI = replace(p_lowerCI, p_lowerCI<0, 0)) %>%
  mutate(p_upperCI = replace(p_upperCI, p_upperCI>1, 1)) %>%
  select(-se)

# merge annual counts with total counts into one table for printing
genotypes_by_region <- tgc_from2010_regionFreq_allGeno %>% 
  mutate(Year="all") %>% 
  bind_rows(tgc_from2010_regionFreq_allGeno_annual) %>% 
  arrange(Region, Year, Final_genotype) %>%
  rename(Genotype=Final_genotype) %>%
  rename(proportion=p) %>%
  relocate(Year, .after=Genotype)
```

``` {r eval=T}
write.csv(genotypes_by_region, file=paste0("SuppTable5_genotypeFreqs_byRegion_2010-2020.csv"), row.names=F)
```

## Table S6: genotype prevalence per country, 2010-2020
``` {r}

country_N_from2010 <- tgc_from2010 %>%
  group_by(Country_Origin)%>% 
  summarize(N =n())

tgc_from2010_countryFreq_allGeno <- tgc_from2010 %>%
  group_by(Region, Country_Origin, Final_genotype)%>% 
  summarize(x =n()) %>%
  left_join(country_N_from2010) %>% # country counts
  mutate(p = x/N) %>% # proportion per region
  mutate(se = sqrt(p*(1-p)/N)) %>%
  mutate(p_lowerCI = p-1.96*se,
         p_upperCI = p+1.96*se) %>%
  mutate(p_lowerCI = replace(p_lowerCI, p_lowerCI<0, 0)) %>%
  mutate(p_upperCI = replace(p_upperCI, p_upperCI>1, 1)) %>%
  select(-se)

# annual counts/freqs
country_N_annual <- tgc_from2010 %>%
  group_by(Country_Origin, Year)%>% 
  summarize(N =n())

tgc_from2010_countryFreq_allGeno_annual <- tgc_from2010 %>%
  group_by(Region, Country_Origin, Final_genotype, Year)%>% 
  summarize(x =n()) %>%
  left_join(country_N_annual) %>% # country annual
  mutate(p = x/N) %>% # proportion per country
  mutate(se = sqrt(p*(1-p)/N)) %>%
  mutate(p_lowerCI = p-1.96*se, p_upperCI = p+1.96*se) %>%
  mutate(p_lowerCI = replace(p_lowerCI, p_lowerCI<0, 0)) %>%
  mutate(p_upperCI = replace(p_upperCI, p_upperCI>1, 1)) %>%
  select(-se)

# merge annual counts with total counts into one table for printing
genotypes_by_country <- tgc_from2010_countryFreq_allGeno %>% 
  mutate(Year="all") %>% 
  bind_rows(tgc_from2010_countryFreq_allGeno_annual) %>% 
  arrange(Region, Country_Origin, Year, Final_genotype) %>%
  rename(Genotype=Final_genotype) %>%
  rename(proportion=p) %>%
  relocate(Year, .after=Genotype)
```

``` {r eval=T}
write.csv(genotypes_by_country, file=paste0("SuppTable6_genotypeFreqs_byCountry_2010-2020.csv"), row.names=F)
```

## genotype prevalence numbers for text - H58 genotypes by region
``` {r}
# H58 regional stats
tgc_from2010_regionFreq_h58 <- tgc_from2010 %>%
  mutate(h58 = startsWith(Final_genotype,"4.3.1")) %>%
  group_by(Region, h58)%>% 
  summarize(x =n()) %>%
  left_join(region_N_from2010) %>% # country counts
  mutate(p = x/N) %>% # proportion per region
  mutate(se = sqrt(p*(1-p)/N)) %>%
  mutate(p_lowerCI = p-1.96*se,
         p_upperCI = p+1.96*se) %>%
  mutate(p_lowerCI = replace(p_lowerCI, p_lowerCI<0, 0)) %>%
  mutate(p_upperCI = replace(p_upperCI, p_upperCI>1, 1)) %>%
  select(-se)

tgc_from2010_regionFreq_h58

# H58 lineage 1 regional stats
tgc_from2010_regionFreq_h58L1 <- tgc_from2010 %>%
  mutate(h58L1 = startsWith(Final_genotype,"4.3.1.1")) %>%
  group_by(Region, h58L1)%>% 
  summarize(x =n()) %>%
  left_join(region_N_from2010) %>% # country counts
  mutate(p = x/N) %>% # proportion per region
  mutate(se = sqrt(p*(1-p)/N)) %>%
  mutate(p_lowerCI = p-1.96*se,
         p_upperCI = p+1.96*se) %>%
  mutate(p_lowerCI = replace(p_lowerCI, p_lowerCI<0, 0)) %>%
  mutate(p_upperCI = replace(p_upperCI, p_upperCI>1, 1)) %>%
  select(-se)

tgc_from2010_regionFreq_h58L1

# H58 lineage 2 regional stats
tgc_from2010_regionFreq_h58L2 <- tgc_from2010 %>%
  mutate(h58L2 = startsWith(Final_genotype,"4.3.1.2")) %>%
  group_by(Region, h58L2)%>% 
  summarize(x =n()) %>%
  left_join(region_N_from2010) %>% # country counts
  mutate(p = x/N) %>% # proportion per region
  mutate(se = sqrt(p*(1-p)/N)) %>%
  mutate(p_lowerCI = p-1.96*se,
         p_upperCI = p+1.96*se) %>%
  mutate(p_lowerCI = replace(p_lowerCI, p_lowerCI<0, 0)) %>%
  mutate(p_upperCI = replace(p_upperCI, p_upperCI>1, 1)) %>%
  select(-se)

tgc_from2010_regionFreq_h58L2

```

## genotype prevalence numbers for text - H58 genotypes by country
``` {r}
# H58 country stats
tgc_from2010_countryFreq_h58 <- tgc_from2010 %>%
  mutate(h58 = startsWith(Final_genotype,"4.3.1")) %>%
  group_by(Region, Country_Origin, h58)%>% 
  summarize(x =n()) %>%
  left_join(country_N_from2010) %>% # country counts
  mutate(p = x/N) %>% # proportion per country
  mutate(se = sqrt(p*(1-p)/N)) %>%
  mutate(p_lowerCI = p-1.96*se,
         p_upperCI = p+1.96*se) %>%
  mutate(p_lowerCI = replace(p_lowerCI, p_lowerCI<0, 0)) %>%
  mutate(p_upperCI = replace(p_upperCI, p_upperCI>1, 1)) %>%
  select(-se)

tgc_from2010_countryFreq_h58

# H58 L1 country stats
tgc_from2010_countryFreq_h58L1 <- tgc_from2010 %>%
  mutate(h58L1 = startsWith(Final_genotype,"4.3.1.1")) %>%
  group_by(Region, Country_Origin, h58L1)%>% 
  summarize(x =n()) %>%
  left_join(country_N_from2010) %>% # country counts
  mutate(p = x/N) %>% # proportion per region
  mutate(se = sqrt(p*(1-p)/N)) %>%
  mutate(p_lowerCI = p-1.96*se,
         p_upperCI = p+1.96*se) %>%
  mutate(p_lowerCI = replace(p_lowerCI, p_lowerCI<0, 0)) %>%
  mutate(p_upperCI = replace(p_upperCI, p_upperCI>1, 1)) %>%
  select(-se)

tgc_from2010_countryFreq_h58L1

# H58 L2 country stats
tgc_from2010_countryFreq_h58L2 <- tgc_from2010 %>%
  mutate(h58L2 = startsWith(Final_genotype,"4.3.1.2")) %>%
  group_by(Region, Country_Origin, h58L2)%>% 
  summarize(x =n()) %>%
  left_join(country_N_from2010) %>% # country counts
  mutate(p = x/N) %>% # proportion per region
  mutate(se = sqrt(p*(1-p)/N)) %>%
  mutate(p_lowerCI = p-1.96*se,
         p_upperCI = p+1.96*se) %>%
  mutate(p_lowerCI = replace(p_lowerCI, p_lowerCI<0, 0)) %>%
  mutate(p_upperCI = replace(p_upperCI, p_upperCI>1, 1)) %>%
  select(-se)

tgc_from2010_countryFreq_h58L2

```

## genotype prevalence numbers for text
``` {r}
# Southern Asia
tgc_from2010_regionFreq_h58 %>% filter(Region=="Southern Asia") %>% filter(h58)
tgc_from2010_countryFreq_h58 %>% filter(Region=="Southern Asia") %>% filter(h58)
tgc_from2010_countryFreq_h58L1 %>% filter(Region=="Southern Asia") %>% filter(h58L1)
tgc_from2010_countryFreq_h58L2 %>% filter(Region=="Southern Asia") %>% filter(h58L2)
genotypes_by_country %>% filter(Region=="Southern Asia") %>% filter(Genotype=="4.3.1") %>% filter(Year=="all")
genotypes_by_country %>% filter(Country_Origin=="Pakistan") %>% filter(Genotype=="4.3.1.1.P1")
tgc_from2010_countryFreq_allGeno %>% filter(Region=="Southern Asia") %>% filter(p>0.05) %>% filter(!startsWith(Final_genotype, "4.3.1"))

# South east Asia
tgc_from2010_regionFreq_h58 %>% filter(Region=="South-eastern Asia") %>% filter(h58)
tgc_from2010_regionFreq_h58L1 %>% filter(Region=="South-eastern Asia") %>% filter(h58L1)
tgc_from2010_countryFreq_h58 %>% filter(Region=="South-eastern Asia") %>% filter(h58)
tgc_from2010_countryFreq_h58L1 %>% filter(Region=="South-eastern Asia") %>% filter(h58L1)
tgc_from2010_countryFreq_allGeno %>% filter(Region=="South-eastern Asia") %>% filter(p>0.05) %>% filter(!startsWith(Final_genotype, "4.3.1"))

# Western Asia
genotypes_by_region %>% filter(Region=="Western Asia") %>% filter(Year=="all")
genotypes_by_country %>% filter(Region=="Western Asia") %>% filter(Year=="all")
tgc_from2010_regionFreq_h58 %>% filter(Region=="Western Asia") %>% filter(h58)

# Eastern Africa
tgc_from2010_regionFreq_h58 %>% filter(Region=="Eastern Africa") %>% filter(h58)
genotypes_by_region %>% filter(Region=="Eastern Africa") %>% filter(Year=="all")
genotypes_by_country %>% filter(Region=="Eastern Africa") %>% filter(Year=="all") %>% filter(Genotype=="4.3.1.1.EA1")
genotypes_by_country %>% filter(Region=="Eastern Africa") %>% filter(Year=="all") %>% filter(Genotype=="4.3.1.2.EA3")
genotypes_by_country %>% filter(Region=="Eastern Africa") %>% filter(Country_Origin=="Kenya") %>% filter(Year %in% c(2012, 2013, 2014, 2015, 2016)) %>% filter(Genotype=="4.3.1.1.EA1") %>% summarise(n=sum(x), N=sum(N), p=n/N)
genotypes_by_country %>% filter(Region=="Eastern Africa") %>% filter(Country_Origin=="Kenya") %>% filter(Year %in% c(2017, 2018, 2019)) %>% filter(Genotype=="4.3.1.2.EA3") %>% summarise(n=sum(x), N=sum(N), p=n/N)

# Southern Africa
tgc_from2010 %>% filter(Region=="Southern Africa") %>% group_by(Country_Origin) %>% summarise(n=n())
tgc_from2010 %>% filter(Region=="Southern Africa") %>% group_by(Country_Origin, Year) %>% summarise(n=n())
tgc_from2010 %>% filter(Country_Origin=="South Africa") %>% filter(Year %in% c(2017, 2018, 2019, 2020)) %>% summarise(n=n())
tgc_from2010 %>% filter(Country_Origin=="South Africa") %>% filter(Year %in% c(2017, 2018, 2019, 2020)) %>% mutate(h58=startsWith(Final_genotype,"4.3.1")) %>% group_by(h58) %>% summarise(n=n()) %>% mutate(p=n/sum(n), N=sum(n))
tgc_from2010 %>% filter(Country_Origin=="South Africa") %>% filter(Year %in% c(2010, 2011, 2012)) %>% mutate(h58=startsWith(Final_genotype,"4.3.1")) %>% group_by(h58) %>% summarise(n=n()) %>% mutate(p=n/sum(n), N=sum(n))
tgc_from2010 %>% filter(Country_Origin=="South Africa") %>% filter(Year %in% c(2017, 2018, 2019, 2020)) %>% group_by(Final_genotype) %>% summarise(n=n()) %>% mutate(p=n/sum(n), N=sum(n))

# Western Africa
genotypes_by_region %>% filter(Region=="Western Africa") %>% filter(Year=="all")
tgc_all %>% filter(Region=="Western Africa") %>% filter(Final_genotype=="3.1.1") %>% group_by(Year, Country_Origin) %>% summarise(n=n()) %>% arrange(Country_Origin, Year)
tgc_all %>% filter(Region=="Western Africa") %>% filter(Final_genotype=="2.3.2") %>% group_by(Year, Country_Origin) %>% summarise(n=n()) %>% arrange(Country_Origin, Year)

# Middle Africa
genotypes_by_region %>% filter(Region=="Middle Africa") %>% filter(Year=="all")
genotypes_by_country %>% filter(Region=="Middle Africa") %>% filter(Year=="all")
tgc_from2010 %>% filter(Region=="Middle Africa") %>% select(Final_genotype, Year, Country_Origin, Country, `Travel Associated`, `Isolating Lab`)

# Northern Africa
tgc_from2010 %>% filter(Region=="Northern Africa") %>% select(Final_genotype, Year, Country_Origin, Country, `Travel Associated`, `Isolating Lab`)

# Central America
genotypes_by_region %>% filter(Region=="Central America") %>% filter(Year=="all")
genotypes_by_country %>% filter(Region=="Central America") %>% filter(Year=="all")
tgc_all %>% filter(Region=="Central America") %>% group_by(`Isolating Lab`) %>% summarise(n=n())
tgc_from2010 %>% filter(Region=="Central America") %>% group_by(Country_Origin) %>% summarise(n=n())
tgc_from2010 %>% filter(Region=="Central America") %>% group_by(Country_Origin, Year) %>% summarise(n=n())
tgc_from2010 %>% filter(Region=="Central America") %>% group_by(Country_Origin, Final_genotype) %>% summarise(n=n()) %>% mutate(p=n/sum(n))
tgc_all %>% filter(Region=="Central America") %>% filter(Year <2010) %>% select(Final_genotype, `Isolating Lab`, Country_Origin, Year)

# Southern America
genotypes_by_region %>% filter(Region=="South America") %>% filter(Year=="all")
tgc_from2010 %>% filter(Region=="South America") %>% group_by(Country_Origin) %>% summarise(n=n()) %>% mutate(p=n/sum(n))
genotypes_by_region %>% filter(Region=="South America") %>% filter(Year=="all") %>% filter(proportion>0.05) %>% arrange(proportion)
tgc_all %>% filter(Country_Origin=="Colombia") %>% select(Final_genotype, Year) %>% group_by(Final_genotype, Year) %>% summarise(n=n()) %>% mutate(p=n/sum(n))
tgc_all %>% filter(Country_Origin=="French Guiana") %>% select(Final_genotype, Year, `Isolating Lab`)
tgc_all %>% filter(Final_genotype=="2.3.2") %>% group_by(Region, Country_Origin) %>% summarise(n=n())

# Pacific Islands
genotypes_by_country %>% filter(Country_Origin=="Papua New Guinea") %>% filter(Year=="all")
genotypes_by_country %>% filter(Country_Origin=="Samoa") %>% filter(Year=="all")
genotypes_by_country %>% filter(Country_Origin=="Fiji") %>% filter(Year=="all")

```

## Identify genotypes to include in map (ie with ≥20% freq in any country, 2010-2020)
``` {r genotype_freqs}

# genotype freqs per region, from 2010
region_N <- tgc_from2010 %>%
  group_by(Region)%>% 
  summarize(region_total =n())

# genotype freqs per country, from 2010
country_N <- tgc_from2010 %>%
  group_by(Country_Origin)%>% 
  summarize(country_total =n())

country_geno <- tgc_from2010 %>%
  group_by(Country_Origin, Final_genotype)%>% 
  summarize(n =n()) %>%
  left_join(country_N) %>% # country counts
  mutate(geno_freq_country = round(n/country_total*100,0)) # percent per region

# genotypes with ≥20% freq in any country; note this includes all H58 subtypes already
geno_country20 <- names(table(country_geno$Final_genotype[country_geno$geno_freq_country>=20]))


# set genotype colours
geno_info <- read_csv("https://raw.githubusercontent.com/katholt/genotyphi/main/Genotype_specification.csv") %>% filter(Genotype %in% geno_country20)

geno_colours <- c(geno_info$`Colour code`,"grey")
names(geno_colours) <- c(geno_info$Genotype, "Other")
geno_colours <- geno_colours[order(names(geno_colours))] # sort for legend


# distinguish H58 subtypes
geno_colours2 <- geno_colours
geno_colours2["4.3.1.1.EA1"] = "#c18cda"
geno_colours2["4.3.1.2.EA2"] = "#ee37c9"
geno_colours2["4.3.1.2.EA3"] = "#94165f"

```

## read in GPS data
``` {r}
# read gps coordinates
gps <- read.csv("../UN_region_coords.csv")%>%
  select(Region, latitude, longitude)
```

## Prepare data for maps with pie charts showing genotype freqs
``` {r}
# pie data, 2010 - 2020, genotype >20% prevalent in an individual country since 2010
tgc_from2010_toMap_countryGeno <-  tgc_from2010 %>%
  mutate(map_genotype = if_else(Final_genotype %in% geno_country20, Final_genotype, "Other"))%>%
  select(Region, Year, Final_genotype, map_genotype)%>%
  dcast(Region ~ map_genotype)%>%
  left_join(gps)%>%
  left_join(region_N)%>%
  mutate(lat = as.numeric(latitude), 
         long = as.numeric(longitude),
         mytext=paste(
            Region, "\n", 
           "N= ", region_total, sep="")
         )
```

## set up to colour map to indicate countries contributing data
```{r country_contrib}

typhi_countryN <- tgc_meta %>%
  filter(Year >= 2010) %>% # restrict to last 10 years
  group_by(Country_Origin)%>%
  summarize(CountryCount2010=n())

# match map object country names
typhi_countryN$Country_Origin <- replace(typhi_countryN$Country_Origin, typhi_countryN$Country_Origin=="United Kingdom", "UK")
typhi_countryN$Country_Origin <- replace(typhi_countryN$Country_Origin, typhi_countryN$Country_Origin=="Viet Nam", "Vietnam")

# add N per country
typhi_Nmap <- map_data('world') %>%
        group_by(region) %>%
  # Merge in Typhi counts
  left_join(typhi_countryN, by = c('region' = 'Country_Origin'))

typhi_Nmap$CountryData <- typhi_Nmap$CountryCount2010 > 0
```

## Fig 1a: map with pies (39 genotypes) without legend
``` {r }
genotype_pie_map_countryGeno_nolegend <- ggplot(data=typhi_Nmap, aes( x = long, y = lat, group=group)) +
  geom_polygon(data=typhi_Nmap, aes(fill = CountryData), color="grey") + 
  scale_fill_manual(values=c("#f2e6d9"), na.value="white") + # pale brown
  new_scale_fill() +
    geom_scatterpie(data = tgc_from2010_toMap_countryGeno, aes(x= long, y=lat , group = Region, r = 9),
                  cols= c(geno_country20, "Other"), color=NA, alpha=1) +
  scale_fill_manual(values = geno_colours2)+
  labs(fill = "Genotype")+
  ylab("")+
  xlab("")+
  theme_minimal()+
  theme(axis.text = element_blank(),
        axis.line = element_blank(),
        axis.ticks = element_blank(), 
        panel.border = element_blank(), 
        panel.grid = element_blank(), 
        legend.title = element_text(face = "bold"), 
        legend.position="none") +
  ggtitle("a) Genotype prevalence by world region, 2010-2020")

genotype_pie_map_countryGeno_nolegend

```

## Fig S2: facet plot genotypes per region, normalised (%)
``` {r}
#select for 2010 - 2020, H58 genotypes plus any genotype >20% prevalent in an individual country
country_year_data_39geno <- tgc_meta %>%
  mutate(map_genotype = if_else(Final_genotype %in% geno_country20, Final_genotype, "Other"))%>%
   filter(Year >=2010) 

region <- table(country_year_data_39geno$Region)
region <- names(region[region>=20])

region_facet_39geno <- country_year_data_39geno %>%
  filter(Year <=2020) %>%
  filter(Region %in% region) %>%
  ggplot(aes(fill=map_genotype, x=Year)) + 
  geom_bar(position="fill") + 
  scale_fill_manual(values = geno_colours2)+
  labs(fill = "Genotype")+
  ylab("")+
  xlab("")+
  facet_wrap(~Region , ncol=3) + 
  theme_bw() +
  theme(strip.background = element_rect(fill ="#f0f0f5"), strip.text=element_text(size=8, face="bold"), axis.text.x = element_text(angle = 45, hjust = 1, size = 6, colour = "black"), legend.text = element_text(size=8), legend.key.size=unit(0.25, "cm"), legend.title = element_text(size=8, face="bold")) +
  guides(fill=guide_legend(ncol=1))

region_facet_39geno
```

``` {r region_facet_39geno_pdf, eval=T}
pdf(file=paste0("SuppFig2_region_facet.pdf"),width=7,height=8)
region_facet_39geno
dev.off()

png(paste0("SuppFig2_region_facet.png"), width=7, height=8, units="in", res=400)
region_facet_39geno
dev.off()
```

## Fig S3: facet plot genotypes per country, excluding key countries, normalised (%)
``` {r}
countryN <- table(tgc_from2010$Country_Origin)
country50 <- names(countryN[countryN>=50])

country_facet_39geno_exclKey <- country_year_data_39geno %>%
  filter(!(Country_Origin %in% country50)) %>%
  ggplot(aes(fill=map_genotype, x=Year)) + 
  geom_bar(position="fill") + 
  scale_fill_manual(values = geno_colours2)+
  labs(fill = "Genotype")+
  ylab("")+
  xlab("")+
  facet_wrap(~Region + Country_Origin, ncol=6) + 
  theme_bw() +
  theme(strip.background = element_rect(fill ="#f0f0f5"), strip.text=element_text(size=8, face="bold"), axis.text.x = element_text(angle = 45, hjust = 1, size = 6, colour = "black"), legend.text = element_text(size=10), legend.key.size=unit(0.25, "cm"), legend.title = element_text(size=10, face="bold")) +
  guides(fill=guide_legend(ncol=1))

country_facet_39geno_exclKey
```

``` {r country_facet_pdf, eval=T}
pdf(file=paste0("SuppFig3_country_facet_exclKey.pdf"),width=13,height=18)
country_facet_39geno_exclKey
dev.off()

png(file=paste0("SuppFig3_country_facet_exclKey.png"),width=13,height=18, units="in", res=400)
country_facet_39geno_exclKey
dev.off()
```

## Fig 1b:facet plot genotypes per country, normalised (%) - key countries
``` {r}
                  
#select for 2010 - 2020, H58 genotypes plus any genotype >20% prevalent in an individual country
country_facet_39geno_keycountries <- tgc_meta %>%
  mutate(map_genotype = if_else(Final_genotype %in% geno_country20, Final_genotype, "Other"))%>%
  select(Year, map_genotype, Region, Country_Origin)%>%
  filter(Year >=2010 & Year <=2020) %>%
  filter(Country_Origin %in% country50) %>%
  filter(!(Country_Origin %in% c("United Kingdom","USA"))) %>%
  ggplot(aes(fill=map_genotype, x=Year)) + 
  geom_bar(position="fill") + 
  scale_fill_manual(values = geno_colours2)+
  labs(fill = "Genotype")+
  ylab("")+
  xlab("")+
  facet_wrap(~Region + Country_Origin, ncol=3) + 
  theme_bw() +
  theme(strip.background = element_rect(fill ="#f0f0f5"), strip.text=element_text(size=8, face="bold"), axis.text.x = element_text(angle = 45, hjust = 1, size = 6, colour = "black"), legend.text = element_text(size=8), legend.key.size=unit(0.25, "cm"), legend.title = element_text(size=8, face="bold")) +
  guides(fill=guide_legend(ncol=1))+
  ggtitle("b) Annual genotype prevalence, for countries with at least 50 genomes")

country_facet_39geno_keycountries
```

## Fig 1: regional genotype map (a) plus national annual prevalences (b)
``` {r country_facet_key_map_pdf, eval=T}
pdf(file=paste0("Fig1_map_genotypesMainCountries_facet.pdf"),width=7,height=9)
  genotype_pie_map_countryGeno_nolegend / (country_facet_39geno_keycountries +  guide_area() + plot_layout(widths=c(5,1))) + plot_layout(nrow=2, heights=c(2,3))
dev.off()

png(file=paste0("Fig1_map_genotypesMainCountries_facet.png"),width=7,height=9, units="in", res=400)
  genotype_pie_map_countryGeno_nolegend / (country_facet_39geno_keycountries +  guide_area() + plot_layout(widths=c(5,1))) + plot_layout(nrow=2, heights=c(2,3))
dev.off()
```


# Section 3 - AMR

## Fig S7a: facet plot genotypes per country, key countries, MDR
``` {r}
              
mdr_genotypes_key_countries <- tgc_meta %>%
  select(Year, Final_genotype, Region, Country_Origin, MDR)%>%
  filter(Year >=2010 & Year <=2020) %>%
  filter(Country_Origin %in% country50) %>%
  filter(!(Country_Origin %in% c("United Kingdom","USA"))) %>%
  mutate(MDR_geno = ifelse(MDR, Final_genotype, "Non-MDR"))

geno_colours_mdr <- geno_colours[names(table(mdr_genotypes_key_countries$MDR_geno))]
geno_colours_mdr["4.3.1.3"] <- geno_colours["4.3.1.3.Bdq"]
geno_colours_mdr["Non-MDR"] <- "lightgrey"
geno_colours_mdr <- na.omit(geno_colours_mdr)

mdr_genotypes_key_countries$MDR_geno <- factor(mdr_genotypes_key_countries$MDR_geno, levels=names(table(mdr_genotypes_key_countries$MDR_geno))[c(12,1:11)], ordered=T)

country_facet_39geno_keycountries_MDR <- mdr_genotypes_key_countries %>%
  ggplot(aes(fill=MDR_geno, x=Year)) + 
  geom_bar(position="fill") + 
  scale_fill_manual(values = geno_colours_mdr)+
  labs(fill = "Genotype")+
  ylab("")+
  xlab("")+
  facet_wrap(~Region + Country_Origin, ncol=3) + 
  theme_bw() +
  theme(strip.background = element_rect(fill ="#f0f0f5"), strip.text=element_text(size=10, face="bold"), axis.text.x = element_text(angle = 45, hjust = 1, size = 8, colour = "black"), legend.text = element_text(size=8), legend.key.size=unit(0.25, "cm"), legend.title = element_text(size=8, face="bold")) +
  guides(fill=guide_legend(ncol=1))+
  ggtitle("a) Annual MDR genotype prevalence, for countries with at least 50 genomes")

country_facet_39geno_keycountries_MDR

```

## Fig S7b: facet plot genotypes per country, key countries, CipI
``` {r}
              
cipNS_genotypes_key_countries <- tgc_meta %>%
  select(Year, Final_genotype, Region, Country_Origin, cipNS)%>%
  filter(Year >=2010 & Year <=2020) %>%
  filter(Country_Origin %in% country50) %>%
  filter(!(Country_Origin %in% c("United Kingdom","USA"))) %>%
  mutate(cipNS_geno = ifelse(cipNS, Final_genotype, "CipS"))

geno_cip <- names(table(cipNS_genotypes_key_countries$Final_genotype)[table(cipNS_genotypes_key_countries$Final_genotype)>=10])

geno_colours_cipI <- read_csv("https://raw.githubusercontent.com/katholt/genotyphi/main/Genotype_specification.csv") %>% filter(Genotype %in% geno_cip)

geno_colours_cipNS <- c(geno_colours_cipI$`Colour code`, "grey")
names(geno_colours_cipNS) <- c(geno_colours_cipI$Genotype, "Other")
geno_colours_cipNS <- geno_colours_cipNS[order(names(geno_colours_cipNS))]
geno_colours_cipNS["CipS"] <- "lightgrey"

cipNS_genotypes_key_countries$cipNS_geno <- factor(cipNS_genotypes_key_countries$cipNS_geno, levels=c("CipS",geno_cip), ordered=T)

country_facet_39geno_keycountries_cipNS <- cipNS_genotypes_key_countries %>%
  mutate(group_genotype = if_else(Final_genotype %in% geno_colours_cipI, Final_genotype, "Other"))%>%
  ggplot(aes(fill=cipNS_geno, x=Year)) + 
  geom_bar(position="fill") + 
  scale_fill_manual(values = geno_colours_cipNS)+
  labs(fill = "Genotype")+
  ylab("")+
  xlab("")+
  facet_wrap(~Region + Country_Origin, ncol=3) + 
  theme_bw() +
  theme(strip.background = element_rect(fill ="#f0f0f5"), strip.text=element_text(size=12, face="bold"), axis.text.x = element_text(angle = 45, hjust = 1, size = 8, colour = "black"), legend.text = element_text(size=8), legend.key.size=unit(0.25, "cm"), legend.title = element_text(size=8, face="bold")) +
  guides(fill=guide_legend(ncol=1))+
  ggtitle("b) Annual CipNS genotype prevalence, for countries with at least 50 genomes")

country_facet_39geno_keycountries_cipNS

```

## Fig S7: MDR and CipNS genotypes, countries with ≥50 genomes
``` {r country_facet_MDR_CipNS_geno_figs, eval=T}
pdf(file=paste0("SuppFig7_genotypesMainCountries_MDR_CipNS.pdf"),width=9,height=12)
country_facet_39geno_keycountries_MDR / country_facet_39geno_keycountries_cipNS
dev.off()

png(file=paste0("SuppFig7_genotypesMainCountries_MDR_CipNS.png"),width=9,height=12, units="in", res=400)
country_facet_39geno_keycountries_MDR / country_facet_39geno_keycountries_cipNS
dev.off()
```

# Section 4 - Compare genotype prevalence estimates by source lab
``` {r country_facet_lab}
#select for 2010 - 2020, H58 genotypes plus any genotype >20% prevalent in an individual country
country_lab_year_data <- tgc_from2010 %>%
  mutate(map_genotype = if_else(Final_genotype %in% geno_country20, Final_genotype, "Other"))%>%
  mutate(Country_lab_label = paste(Region, ":", Country_Origin, ":", `Isolating Lab`)) %>%
  select(Country_lab_label, Year, map_genotype, Final_genotype, Region, Country_Origin, `Isolating Lab`)%>%
  filter(Year >=2010) 
```

## Compare key genotype frequencies across countries, by lab - South Asia
``` {r}

country_lab_year_data_SA <- country_lab_year_data %>% 
  filter(Country_Origin %in% c("Bangladesh", "India", "Nepal", "Pakistan"))

country_lab_year_data_SA <- country_lab_year_data_SA %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="CDC", "*US (CDC)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="PHE", "*England (PHE)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="MDU", "*Australia (MDU)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="ESR", "*New Zealand (ESR)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="CHR", "Dhaka (CHR)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="ICD", "Dhaka (ICD)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="CMH", "Chittagong (ICD)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="AII", "New Delhi (AII)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="CML", "Ludhiana (CML)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="CNH", "New Delhi (CNH)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="KHM", "Mumbai (KHM)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="KKC", "Chennai (KKC)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="RDT", "Bathalapalli (RDT)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="SAP", "New Delhi (SAP)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="CMC", "Vellore (CMC)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="BCH", "Mumbai (KIM)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="PGI", "Chandigarh (PGI)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="SJB", "Bengaluru (SJB)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="KUH", "Dhulikhel (KUH)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="PAH", "Lalitpur (PAH)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="AKU", "Karachi (AKU)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="JHL", "Lahore (JHL)"))

lab_N_SA <- country_lab_year_data_SA %>%
  group_by(Country_Origin, `Isolating Lab`)%>% 
  summarize(lab_total =n())

lab_N_SA

country_lab_data_SA_genotypeFreq <- country_lab_year_data_SA %>% 
  group_by(Country_Origin, `Isolating Lab`, Final_genotype) %>%
  summarise (n=n())%>%
  left_join(lab_N_SA) %>% # annual lab counts
  mutate(lab_freq = n/lab_total, 
         lab_freq_sd = sqrt((lab_freq*(1-lab_freq))/lab_total),
         min=lab_freq-1.96*lab_freq_sd,
         max=lab_freq+1.96*lab_freq_sd)

# 4.3.1.2 in India
country_lab_data_SA_genotypeFreq %>% filter(Country_Origin=="India") %>% filter(Final_genotype=="4.3.1.2")
```

## add pooled country-wide estimate with CIs
``` {r }
# add pooled estimate
country_lab_data_SA_genotypeFreq <- tgc_from2010_countryFreq_allGeno %>% 
  filter(Country_Origin %in% c("India", "Bangladesh","Nepal","Pakistan")) %>%
  rename(lab_freq=p, min=p_lowerCI, max=p_upperCI, lab_total=N, n=x) %>%
  mutate(`Isolating Lab`="(Pooled)") %>%
  bind_rows(country_lab_data_SA_genotypeFreq) %>%
  ungroup() %>%
  select(-c(Region, lab_freq_sd))
```

## facet plot for genotype prevalence estimates by lab, South Asia
``` {r} 
# choose most common genotypes to plot
SA_geno_freq <- rev(sort(table(country_lab_year_data_SA$Final_genotype)))

country_lab_data_SA_genotypeFreq_estimates <-
country_lab_data_SA_genotypeFreq %>%
  mutate(pooled=if_else(`Isolating Lab`=="(Pooled)",1,0.5)) %>%
  filter(Final_genotype %in% names(SA_geno_freq[1:9])) %>%
  filter(lab_total >=20) %>%
  mutate(country_lab=paste(Country_Origin, ":", `Isolating Lab`)) %>%
  ggplot() +
  geom_linerange( mapping=aes(y=country_lab,  xmin=min, xmax=max, colour=Country_Origin)) +
  geom_point(mapping=aes(y=country_lab, x=lab_freq, colour=Country_Origin, alpha=pooled), size=1) +
  facet_wrap(. ~ Final_genotype, ncol=3) + theme_bw() +
  scale_color_manual(values=c("red","blue","orange","black")) + 
  guides(alpha = "none") +
  labs(color="Country:", x="Genotype prevalence estimate (%)", y="Source laboratory") + 
  theme(strip.background = element_rect(fill ="#f0f0f5"), strip.text=element_text(size=10, face="bold"), axis.text.x = element_text(angle = 45, hjust = 1, size = 8, colour = "black"), axis.text.y = element_text(size = 7, colour = "black"), legend.title = element_text(size=10, face="bold"), legend.position="bottom")

country_lab_data_SA_genotypeFreq_estimates

country_lab_data_SA_genotypeFreq
```

## Fig S12: genotype freq estimates by lab, South Asia
``` {r country_lab_data_SA_genotypeFreq_estimates_figs, eval=T}
pdf(file=paste0("SuppFig12_country_lab_data_SA_genotypeFreq_estimates.pdf"),width=8,height=12)
country_lab_data_SA_genotypeFreq_estimates
dev.off()

png(file=paste0("SuppFig12_country_lab_data_SA_genotypeFreq_estimates.png"),width=8,height=12, units="in", res=400)
country_lab_data_SA_genotypeFreq_estimates
dev.off()
```

## compare CIs
``` {r}
# lab-specific
lab_level <- country_lab_data_SA_genotypeFreq %>% 
  filter(`Isolating Lab` != "(Pooled)")

pooled <- country_lab_data_SA_genotypeFreq %>% 
  filter(`Isolating Lab` == "(Pooled)") %>%
  rename(pooled_freq=lab_freq, pooled_min=min, pooled_max=max)

labs_pooled <- left_join(lab_level, pooled, by=c("Country_Origin", "Final_genotype"))

labs_pooled <- labs_pooled %>% 
  filter(Final_genotype %in% names(SA_geno_freq[1:9])) %>%
  filter(lab_total.x >=20)

nrow(labs_pooled)

labs_pooled_overlap_estimate <- labs_pooled %>%
  filter((lab_freq > pooled_min) & (lab_freq < pooled_max))

nrow(labs_pooled_overlap_estimate)/nrow(labs_pooled)

labs_pooled_overlap_interval <- labs_pooled %>%
  filter(!( (max<pooled_min) | (min>pooled_max)))

nrow(labs_pooled_overlap_interval)/nrow(labs_pooled)
```

## Fig 6a: Genotype freqs annual dist per lab, 2010-2020 - South Asia, labs with N≥20
``` {r country_facet_lab_SAsia}

country_lab_year_data_SA <- country_lab_year_data %>% 
  filter(Country_Origin %in% c("Bangladesh", "India", "Nepal", "Pakistan"))

# set genotype colours
geno_info_SA <- read_csv("https://raw.githubusercontent.com/katholt/genotyphi/main/Genotype_specification.csv") %>% filter(Genotype %in% country_lab_year_data_SA$Final_genotype)

geno_colours_SA <- c(geno_info_SA$`Colour code`)

names(geno_colours_SA) <- c(geno_info_SA$Genotype)

# distinguish H58 subtypes
geno_colours_SA["4.3.1.2.EA2"] = "#ee37c9"
geno_colours_SA["4.3.1.2.EA3"] = "#94165f"

geno_colours_SA <- geno_colours_SA[order(names(geno_colours_SA))] # sort for legend

lab_counts <- table(country_lab_year_data$Country_lab_label)

# South Asian countries with multiple source labs, with N≥20 per lab
country_facet_lab_SAsia <- country_lab_year_data_SA %>% 
  filter(Country_lab_label %in% names(lab_counts[lab_counts>=20])) %>%
  ggplot(aes(fill=Final_genotype, x=Year)) + 
  geom_bar(position="fill") + 
  scale_fill_manual(values = geno_colours_SA)+
  labs(fill = "Genotype", x="", y="")+
  facet_wrap(~Country_Origin + `Isolating Lab`, ncol=7) + 
  theme_bw() +
  theme(strip.background = element_rect(fill ="#f0f0f5"), strip.text=element_text(size=9, face="bold"), axis.text.x = element_text(angle = 45, hjust = 1, size = 6, colour = "black"), legend.title=element_text(size=8, face="bold"), legend.text = element_text(size=8), legend.key.size=unit(.25, "cm"), legend.position="bottom") +
  guides(fill=guide_legend(nrow=4))

country_facet_lab_SAsia
```

## Genotype per lab, frequence barplot, Nigeria
``` {r country_facet_lab_Africa}
country_lab_year_data_Nigeria <- country_lab_year_data %>% 
  filter(Country_Origin == "Nigeria")

# set genotype colours
geno_info_nigeria <- read_csv("https://raw.githubusercontent.com/katholt/genotyphi/main/Genotype_specification.csv") %>% filter(Genotype %in% country_lab_year_data_Nigeria$Final_genotype)

geno_colours_nigeria <- c(geno_info_nigeria$`Colour code`,"grey")

names(geno_colours_nigeria) <- c(geno_info_nigeria$Genotype, "Other")

geno_colours_nigeria <- geno_colours_nigeria[order(names(geno_colours_nigeria))] # sort for legend

country_facet_lab_Nigeria <- country_lab_year_data_Nigeria %>% 
  filter(Country_lab_label %in% names(lab_counts[lab_counts>=10])) %>%
  filter(!is.na(`Isolating Lab`)) %>%
  ggplot(aes(fill=Final_genotype, x=Year)) + 
  geom_bar(position="fill") + 
  scale_fill_manual(values = geno_colours_nigeria)+
  labs(fill = "Genotype", x="", y="", title="c) Annual genotype prevalence, by lab")+
  facet_wrap(~`Isolating Lab`, ncol=2) + 
  theme_bw() +
  theme(strip.background = element_rect(fill ="#f0f0f5"),
        strip.text=element_text(size=10, face="bold"), 
        axis.text.x = element_text(angle = 45, hjust = 1, size = 6, colour = "black"),
        axis.text.y = element_text(size = 7, colour = "black"),
        legend.title=element_text(size=8, face="bold"), 
        legend.text = element_text(size=8), legend.key.size=unit(.25, "cm"),
        legend.position="right", 
        plot.title=element_text(size = 9, colour = "black", face="bold"))

country_facet_lab_Nigeria
```


## Compare genotype frequency estimates between labs, Nigeria
``` {r}

lab_N_Nigeria <- country_lab_year_data_Nigeria %>%
  group_by(`Isolating Lab`)%>% 
  summarize(lab_total =n())

lab_N_Nigeria

country_lab_data_Nigeria_genotypeFreq <- country_lab_year_data_Nigeria %>% 
  group_by(`Isolating Lab`, Final_genotype) %>%
  summarise (n=n())%>%
  left_join(lab_N_Nigeria) %>% # annual lab counts
  mutate(lab_freq = n/lab_total, 
         lab_freq_sd = sqrt((lab_freq*(1-lab_freq))/lab_total),
         min=lab_freq-1.96*lab_freq_sd,
         max=lab_freq+1.96*lab_freq_sd)

country_lab_data_Nigeria_genotypeFreq %>% filter(Final_genotype=="3.1.1")
```

## add pooled country-wide estimate with CIs
``` {r }
# add pooled estimate
country_lab_data_Nigeria_genotypeFreq <- tgc_from2010_countryFreq_allGeno %>% 
  filter(Country_Origin %in% c("Nigeria")) %>%
  rename(lab_freq=p, min=p_lowerCI, max=p_upperCI, lab_total=N, n=x) %>%
  mutate(`Isolating Lab`="(Pooled)") %>%
  bind_rows(country_lab_data_Nigeria_genotypeFreq) %>%
  ungroup() %>%
  select(-c(Region, lab_freq_sd, Country_Origin))
```

## facet line plot of estimates for key genotypes by lab, Nigeria
``` {r} 
# choose most common genotypes to plot
nigeria_geno_freq <- rev(sort(table(country_lab_year_data_Nigeria$Final_genotype)))

country_lab_data_Nigeria_genotypeFreq_estimates <-
country_lab_data_Nigeria_genotypeFreq %>%
  mutate(pooled=if_else(`Isolating Lab`=="(Pooled)","Pooled","Individual")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="CDC", "*US (CDC)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="PHE", "*England (PHE)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="IBA", "Ibadan (IBD)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="ZMC", "Abuja (ZMC)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="(Pooled)", "Nigeria (Pooled)")) %>%
  filter(Final_genotype %in% names(nigeria_geno_freq[1:5])) %>%
  filter(lab_total >=10) %>%
  ggplot() +
  geom_linerange( mapping=aes(y=`Isolating Lab`,  xmin=min, xmax=max, colour=pooled)) +
  geom_point(mapping=aes(y=`Isolating Lab`, x=lab_freq, colour=pooled), size=1) +
  facet_wrap(. ~ Final_genotype, ncol=3) + theme_bw() +
  scale_color_manual(values=c("red","black")) + 
  xlab("") +
  ylab("") +
  labs(color="Estimate type")+ 
  ggtitle("a) Genotype prevalence, by lab") +
  theme(strip.background = element_rect(fill ="#f0f0f5"),
        strip.text=element_text(size=10, face="bold"), 
        axis.text.x = element_text(angle = 45, hjust = 1, size = 6, colour = "black"),
        axis.text.y = element_text(size = 7, colour = "black"),
        legend.title=element_text(size=8, face="bold"), 
        legend.text = element_text(size=8), legend.key.size=unit(.25, "cm"),
        legend.position="right", 
        plot.title=element_text(size = 9, colour = "black", face="bold"))

country_lab_data_Nigeria_genotypeFreq_estimates
```

# Section 4b - Compare AMR estimates by source lab

## Fig 6b: tabulate annual resistance freqs per country and lab, for South Asia
``` {r annual_by_country_source}

annual_res_country_lab <- tgc_meta %>%
  mutate(cefR = as.numeric(CEP), 
         XDR = if_else(XDR == T, 1, 0), 
         MDR = if_else(MDR ==T, 1, 0), 
         cipNS = if_else(cipNS == T, 1, 0), 
         cipR = if_else(cipR == T, 1, 0), 
         aziR = if_else(aziR == T, 1, 0)) %>% #convert PW AMR calls to numeric values
  filter(Year >= 2010) %>% # restrict to 2010 onwards
    group_by(Country_Origin, Year, `Isolating Lab`) %>%
  summarize(n=n(),
            sumMDR= sum(MDR),
            MDR= round(sumMDR/n*100, digits =0),
            sumXDR= sum(XDR),
            XDR= round(sumXDR/n*100, digits = 0),
            sumcipNS = sum(cipNS),
            cipNS = round(sumcipNS/n*100, digits = 0),
            sumcipR = sum(cipR),
            cipR = round(sumcipR/n*100, digits = 0),
            sumcefR = sum(cefR),
            cefR = round(sumcefR/n*100, digits = 0),
            sumaziR = sum(aziR),
            aziR = round(sumaziR/n*100, digits =0)
            ) %>% 
  unique()
```

## pooled estimates (borrowed from AMR Rmd)
``` {r tabulate_AMR}
# clean up AMR data (for surveillance-ready samples)
res_data <- tgc_meta %>%
  mutate(cefR = as.numeric(CEP), 
         XDR = if_else(XDR == T, 1, 0), 
         MDR = if_else(MDR ==T, 1, 0), 
         cipNS = if_else(cipNS == T, 1, 0), 
         cipR = if_else(cipR == T, 1, 0), 
         aziR = if_else(aziR == T, 1, 0)) %>% #convert PW AMR calls to numeric values
  select(Country_Origin, Region, Year, cefR, cipNS, cipR, MDR, XDR, aziR, IncHI1)

# map object has "UK", "Vietnam", changes ours to match this string format
res_data$Country_Origin <- replace(res_data$Country_Origin, res_data$Country_Origin=="United Kingdom", "UK")
res_data$Country_Origin <- replace(res_data$Country_Origin, res_data$Country_Origin=="Viet Nam", "Vietnam")

# prevalence per country, for 2010 onwards
res_freq_table <- res_data %>%
  filter(Year >= 2010) %>% # restrict to last 10 years
  group_by(Country_Origin)%>%
  summarize(n=n(),
            sumMDR= sum(MDR),
            MDR= round(sumMDR/n*100, digits =0),
            sumXDR= sum(XDR),
            XDR= round(sumXDR/n*100, digits = 0),
            sumcipNS = sum(cipNS),
            cipNS = round(sumcipNS/n*100, digits = 0),
            sumcipR = sum(cipR),
            cipR = round(sumcipR/n*100, digits = 0),
            sumcefR = sum(cefR),
            cefR = round(sumcefR/n*100, digits = 0),
            sumaziR = sum(aziR),
            aziR = round(sumaziR/n*100, digits =0),
            MDR_sd = sqrt((sumMDR/n*(1-sumMDR/n))/n),
            XDR_sd = sqrt((sumXDR/n*(1-sumXDR/n))/n),
            cipNS_sd = sqrt((sumcipNS/n*(1-sumcipNS/n))/n),
            cipR_sd = sqrt((sumcipR/n*(1-sumcipR/n))/n),
            cefR_sd = sqrt((sumcefR/n*(1-sumcefR/n))/n),
            aziR_sd = sqrt((sumaziR/n*(1-sumaziR/n))/n)
            ) %>% 
  unique()

# annual by country
res_freq_annual_table <- res_data %>%
  filter(Year >= 2000) %>% # restrict to last 20 years
  mutate(MDR_IncHI1 = ifelse(IncHI1, MDR, 0)) %>%
  group_by(Country_Origin, Year) %>%
  summarize(n=n(),
            sumMDR= sum(MDR),
            MDR= round(sumMDR/n*100, digits =0),
            sumXDR= sum(XDR),
            XDR= round(sumXDR/n*100, digits = 0),
            sumcipNS = sum(cipNS),
            cipNS = round(sumcipNS/n*100, digits = 0),
            sumcipR = sum(cipR),
            cipR = round(sumcipR/n*100, digits = 0),
            sumcefR = sum(cefR),
            cefR = round(sumcefR/n*100, digits = 0),
            sumaziR = sum(aziR),
            aziR = round(sumaziR/n*100, digits =0),
            MDR_sd = sqrt((sumMDR/n*(1-sumMDR/n))/n),
            XDR_sd = sqrt((sumXDR/n*(1-sumXDR/n))/n),
            cipNS_sd = sqrt((sumcipNS/n*(1-sumcipNS/n))/n),
            cipR_sd = sqrt((sumcipR/n*(1-sumcipR/n))/n),
            cefR_sd = sqrt((sumcefR/n*(1-sumcefR/n))/n),
            aziR_sd = sqrt((sumaziR/n*(1-sumaziR/n))/n),
            sumMDR_IncHI1 = sum(MDR_IncHI1),
            `IncHI1 amongst MDR` = round(sumMDR_IncHI1/sumMDR*100, digits=0)) %>% 
  unique()
```

## Compare annual AMR for labs within countries - line plots, South Asia
  
``` {r}

southAsia_amr_lab <- annual_res_country_lab %>%
  filter(Country_Origin %in% c("Bangladesh","India","Nepal","Pakistan")) %>%
  filter(n>=10) %>% # include only estimates with N≥10
  as.data.frame() %>%
    melt(id.vars=c("Country_Origin","Year","Isolating Lab"), variable.name="AMR") %>%
    filter(AMR %in% c("MDR","cefR","cipR","cipNS")) 

southAsia_amr_lab$value <- as.numeric(as.character(southAsia_amr_lab$value))

southAsia_amr_lab$Year <- as.numeric(as.character(southAsia_amr_lab$Year))

res_freq_annual_table$Year <- as.numeric(as.character(res_freq_annual_table$Year))

## add line for combined estimate
south_asia_amr <- res_freq_annual_table %>% 
  filter(Country_Origin %in% c("Bangladesh","India","Nepal","Pakistan")) %>%
  filter(n>=10) %>% # plot only those years with sufficient data
  as.data.frame() %>%
  melt(id.vars=c("Country_Origin","Year"), variable.name="AMR") %>%
  filter(AMR %in% c("MDR","cefR","cipR","cipNS")) %>% 
  mutate(`Isolating Lab`="Pooled") %>%
  bind_rows(southAsia_amr_lab) %>%
  mutate(estimate_type=ifelse(`Isolating Lab`=="Pooled",2,1)) %>%
  replace_na(list(estimate_type = 1, `Isolating Lab` = "UNK")) # NA lab is unknown lab from Pakistan data in Wong 2015

# order levels
south_asia_amr$`Isolating Lab` <- factor(south_asia_amr$`Isolating Lab`)
index_combined <- which("Pooled" == levels(south_asia_amr$`Isolating Lab`))

south_asia_amr$`Isolating Lab` <- factor(south_asia_amr$`Isolating Lab`, levels=levels(south_asia_amr$`Isolating Lab`)[c(index_combined, 1:(index_combined-1), (index_combined+1):length(levels(south_asia_amr$`Isolating Lab`)))], ordered=T)

southAsia_amr_lab_plot_combinedEst <- ggplot(south_asia_amr, aes(x=Year, y=value, group=`Isolating Lab`, colour=`Isolating Lab`)) +
  geom_line(size = 1, aes(group=`Isolating Lab`)) +
  geom_point(size = 1) +
  facet_wrap(. ~ Country_Origin + AMR) + theme_bw() + 
  scale_color_manual(values=c(alpha("black",1), alpha(unname(alphabet())[1:22],0.5))) + 
  ylab("Resistance (%)") +
  theme(strip.background = element_rect(fill ="#f0f0f5"), strip.text=element_text(size=10, face="bold"), axis.text.x = element_text(angle = 45, hjust = 1, size = 8, colour = "black"), legend.title = element_text(size=10, face="bold"), legend.position="bottom") +
  guides(colour=guide_legend(nrow=3))

southAsia_amr_lab_plot_combinedEst

```


## Fig 6: combined fig with annual AMR & genotype for South Asia
``` {r, eval=T}

pdf(file=paste0("Fig6_annualGeno_annualAMR_by_lab_SouthAsia.pdf"),width=8,height=12)
(country_facet_lab_SAsia + ggtitle("a) Annual genotype prevalence, by lab")) / (southAsia_amr_lab_plot_combinedEst + ggtitle("b) Annual AMR prevalence, by lab"))
dev.off()

png(file=paste0("Fig6_annualGeno_annualAMR_by_lab_SouthAsia.png"),width=8, height=12, units="in", res=400)
(country_facet_lab_SAsia + ggtitle("a) Annual genotype prevalence, by lab")) / (southAsia_amr_lab_plot_combinedEst + ggtitle("b) Annual AMR prevalence, by lab"))
dev.off()

```

## Compare AMR frequencies across countries, by lab - South Asia
``` {r}

country_lab_data_SA_amrFreq <- tgc_from2010 %>% 
  filter(Country_Origin %in% c("Bangladesh", "India", "Nepal", "Pakistan")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="CDC", "*US (CDC)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="PHE", "*England (PHE)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="MDU", "*Australia (MDU)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="ESR", "*New Zealand (ESR)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="CHR", "Dhaka (CHR)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="ICD", "Dhaka (ICD)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="CMH", "Chittagong (ICD)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="AII", "New Delhi (AII)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="CML", "Ludhiana (CML)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="CNH", "New Delhi (CNH)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="KHM", "Mumbai (KHM)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="KKC", "Chennai (KKC)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="RDT", "Andhra Pradesh (RDT)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="SAP", "New Delhi (SAP)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="CMC", "Vellore (CMC)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="KIMS", "Mumbai (KIM)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="PGI", "Chandigarh (PGI)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="SJB", "Bengaluru (SJB)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="KUH", "Dhulikhel (KUH)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="PAH", "Lalitpur (PAH)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="AKU", "Karachi (AKU)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="JHL", "Lahore (JHL)")) %>%
  select(Country_Origin, Region, `Isolating Lab`, MDR, cipNS, cipR, aziR, CEP, XDR) %>%
  rename(cefR=CEP) %>%
  mutate(Country_lab_label = paste(Country_Origin, ":", `Isolating Lab`)) %>%
  select(-Region, -`Isolating Lab`) %>%
  melt(id.vars=c("Country_lab_label","Country_Origin"), variable.name="AMR") %>%
  group_by(Country_lab_label, Country_Origin, AMR) %>%
  summarise (n=n(),
             x=sum(value),
             .groups = "keep") %>%
  mutate(lab_freq = x/n, 
         lab_freq_sd = sqrt((lab_freq*(1-lab_freq))/n),
         min=lab_freq-1.96*lab_freq_sd,
         max=lab_freq+1.96*lab_freq_sd)
```

## add pooled country-wide estimate with CIs
``` {r }
# add pooled estimate
SA_amrFreq <- tgc_from2010 %>% 
  select(Country_Origin, MDR, cipNS, cipR, aziR, CEP, XDR) %>%
  rename(cefR=CEP) %>%
  filter(Country_Origin %in% c("Bangladesh", "India", "Nepal", "Pakistan")) %>%
melt(id.vars=c("Country_Origin"), variable.name="AMR") %>%
  group_by(Country_Origin, AMR) %>%
  summarise (n=n(),
             x=sum(value),
             .groups = "keep") %>%
  mutate(lab_freq = x/n, 
         lab_freq_sd = sqrt((lab_freq*(1-lab_freq))/n),
         min=lab_freq-1.96*lab_freq_sd,
         max=lab_freq+1.96*lab_freq_sd) %>%
  mutate(Country_lab_label=paste0(Country_Origin, " : (Pooled)")) %>%
  bind_rows(country_lab_data_SA_amrFreq)
```

## Fig S13: facet estimate plot for AMR freqs in South Asia labs
``` {r} 

country_lab_data_SA_amrFreq_estimates <-
SA_amrFreq %>%
  mutate(pooled=if_else(grepl("(Pooled)", Country_lab_label),1,0.5)) %>%
  filter(n >=20) %>% #minimum annual count per lab
  ggplot() +
  geom_linerange( mapping=aes(y=Country_lab_label, xmin=min, xmax=max, colour=Country_Origin)) +
  geom_point(mapping=aes(y=Country_lab_label, x=lab_freq, colour=Country_Origin, alpha=pooled), size=1) +
  facet_wrap(. ~ AMR, ncol=3) + theme_bw() +
  scale_color_manual(values=c("red","blue","orange","black")) + 
  xlab("AMR prevalence estimate (%)") +
  ylab("Source laboratory") +
  guides(alpha = "none") +
  labs(color="Country:")+ 
  theme(strip.background = element_rect(fill ="#f0f0f5"), strip.text=element_text(size=10, face="bold"), axis.text.x = element_text(angle = 45, hjust = 1, size = 8, colour = "black"), axis.text.y = element_text(size = 8, colour = "black"), legend.title = element_text(size=10, face="bold"), legend.position="bottom")

country_lab_data_SA_amrFreq_estimates
```


``` {r country_lab_data_SA_amrFreq_estimates_estimates_pdf, eval=T}
pdf(file=paste0("SuppFig13_country_lab_data_SA_amrFreq_estimates.pdf"),width=8, height=9)
country_lab_data_SA_amrFreq_estimates
dev.off()

png(file=paste0("SuppFig13_country_lab_data_SA_amrFreq_estimates.png"),width=8, height=9, units="in", res=400)
country_lab_data_SA_amrFreq_estimates
dev.off()
```

## compare CIs for AMR in South Asia
``` {r}
# lab-specific
lab_level <- SA_amrFreq %>% 
  filter(!(Country_lab_label %in% c("Bangladesh : (Pooled)", "India : (Pooled)", "Nepal : (Pooled)", "Pakistan : (Pooled)")))

pooled <- SA_amrFreq %>% 
  filter(Country_lab_label %in% c("Bangladesh : (Pooled)", "India : (Pooled)", "Nepal : (Pooled)", "Pakistan : (Pooled)")) %>%
  rename(pooled_freq=lab_freq, pooled_min=min, pooled_max=max)

labs_pooled <- left_join(lab_level, pooled, by=c("Country_Origin", "AMR"))

labs_pooled <- labs_pooled %>% 
  filter(n.x >=20)

nrow(labs_pooled)

labs_pooled_overlap_estimate <- labs_pooled %>%
  filter((lab_freq > pooled_min) & (lab_freq < pooled_max))

nrow(labs_pooled_overlap_estimate)/nrow(labs_pooled)

labs_pooled_overlap_interval <- labs_pooled %>%
  filter(!( (max<pooled_min) | (min>pooled_max)))

nrow(labs_pooled_overlap_interval)/nrow(labs_pooled)

```

## Compare AMR estimates for Nigeria from different labs 
``` {r}
country_lab_data_Nigeria_amrFreq <- tgc_from2010 %>% 
  filter(Country_Origin == "Nigeria") %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="CDC", "*US (CDC)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="PHE", "*England (PHE)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="IBA", "Ibadan (IBD)")) %>%
  mutate(`Isolating Lab` = replace(`Isolating Lab`, `Isolating Lab`=="ZMC", "Abuja (ZMC)")) %>%
  select(`Isolating Lab`, MDR, cipNS, cipR, aziR, CEP, XDR) %>%
  rename(cefR=CEP) %>%
  melt(id.vars=c("Isolating Lab"), variable.name="AMR") %>%
  group_by(`Isolating Lab`, AMR) %>%
  summarise (n=n(),
             x=sum(value),
             .groups = "keep") %>%
  mutate(lab_freq = x/n, 
         lab_freq_sd = sqrt((lab_freq*(1-lab_freq))/n),
         min=lab_freq-1.96*lab_freq_sd,
         max=lab_freq+1.96*lab_freq_sd)

nigeria_amrFreq <- tgc_from2010 %>% 
  select(Country_Origin, MDR, cipNS, cipR, aziR, CEP, XDR) %>%
  rename(cefR=CEP) %>%
  filter(Country_Origin == "Nigeria") %>%
melt(id.vars=c("Country_Origin"), variable.name="AMR") %>%
  group_by(Country_Origin, AMR) %>%
  summarise (n=n(),
             x=sum(value),
             .groups = "keep") %>%
  mutate(lab_freq = x/n, 
         lab_freq_sd = sqrt((lab_freq*(1-lab_freq))/n),
         min=lab_freq-1.96*lab_freq_sd,
         max=lab_freq+1.96*lab_freq_sd) %>%
  mutate(Country_Origin=replace(Country_Origin, Country_Origin=="Nigeria", "Nigeria (Pooled)")) %>%
  rename(`Isolating Lab`=Country_Origin) %>%
  bind_rows(country_lab_data_Nigeria_amrFreq)

```

## Fig 7b: facet estimate plot for AMR freqs in Nigeria labs
``` {r} 

country_lab_data_Nigeria_amrFreq_estimates <-
nigeria_amrFreq %>%
  filter(n>=10) %>%
  mutate(pooled=ifelse(`Isolating Lab`=="Nigeria (Pooled)","Pooled","Individual")) %>%
  ggplot() +
  geom_linerange( mapping=aes(y=`Isolating Lab`, xmin=min, xmax=max, colour=pooled)) +
  geom_point(mapping=aes(y=`Isolating Lab`, x=lab_freq, colour=pooled), size=1) +
  facet_wrap(. ~ AMR, ncol=3) + theme_bw() +
  labs(x="", y="", title="b) AMR prevalence, by lab", colour="Estimate type") +
  scale_color_manual(values=c("red","black")) +
  theme(strip.background = element_rect(fill ="#f0f0f5"),
        strip.text=element_text(size=10, face="bold"), 
        axis.text.x = element_text(angle = 45, hjust = 1, size = 6, colour = "black"),
        axis.text.y = element_text(size = 7, colour = "black"),
        legend.title=element_text(size=8, face="bold"), 
        legend.text = element_text(size=8), legend.key.size=unit(.25, "cm"),
        legend.position="right", 
        plot.title=element_text(size = 9, colour = "black", face="bold"))

country_lab_data_Nigeria_amrFreq_estimates
```

## Fig 7: combined fig with annual AMR & genotype for Nigeria
``` {r, eval=T}

pdf(file=paste0("Fig7_Nigeria_labcomparisons.pdf"),width=5, height=8)
country_lab_data_Nigeria_genotypeFreq_estimates / country_lab_data_Nigeria_amrFreq_estimates / country_facet_lab_Nigeria
dev.off()

png(file=paste0("Fig7_Nigeria_labcomparisons.png"),width=5, height=8, units="in", res=400)
country_lab_data_Nigeria_genotypeFreq_estimates / country_lab_data_Nigeria_amrFreq_estimates / country_facet_lab_Nigeria
dev.off()

```
